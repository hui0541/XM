import yaml
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QTextEdit, 
                               QPushButton, QMessageBox, QLabel)
from PySide6.QtGui import QFont, QColor
from utils import SystemUtils

class ConfigEditor(QWidget):
    def __init__(self, config_path):
        super().__init__()
        self.config_path = config_path
        self.setup_ui()
        self.load_file()

    def setup_ui(self):
        layout = QVBoxLayout(self)
        
        # å¤´éƒ¨è¯´æ˜
        header = QHBoxLayout()
        title = QLabel(f"ç¼–è¾‘é…ç½®æ–‡ä»¶: {self.config_path}")
        title.setStyleSheet("color: #aaaaaa; font-weight: bold;")
        header.addWidget(title)
        
        self.btn_save = QPushButton("ğŸ’¾ ä¿å­˜å¹¶æ ¡éªŒ")
        self.btn_save.clicked.connect(self.save_file)
        self.btn_save.setStyleSheet("background-color: #007acc; color: white;")
        
        self.btn_reload = QPushButton("ğŸ”„ é‡ç½®")
        self.btn_reload.clicked.connect(self.load_file)
        
        header.addStretch()
        header.addWidget(self.btn_reload)
        header.addWidget(self.btn_save)
        layout.addLayout(header)

        # ç¼–è¾‘åŒº
        self.editor = QTextEdit()
        self.editor.setFont(QFont("Consolas", 10))
        self.editor.setStyleSheet("""
            QTextEdit { 
                background-color: #1e1e1e; 
                color: #d4d4d4; 
                border: 1px solid #3c3c3c;
            }
        """)
        layout.addWidget(self.editor)

    def load_file(self):
        try:
            with open(self.config_path, 'r', encoding='utf-8') as f:
                content = f.read()
                self.editor.setPlainText(content)
        except Exception as e:
            QMessageBox.critical(self, "é”™è¯¯", f"æ— æ³•è¯»å–æ–‡ä»¶: {str(e)}")

    def save_file(self):
        content = self.editor.toPlainText()
        # 1. è¯­æ³•æ ¡éªŒ
        try:
            yaml.safe_load(content)
        except yaml.YAMLError as e:
            QMessageBox.warning(self, "YAML æ ¼å¼é”™è¯¯", f"é…ç½®æ ¼å¼æœ‰è¯¯ï¼Œæ— æ³•ä¿å­˜:\n{str(e)}")
            return

        # 2. è½ç›˜
        try:
            with open(self.config_path, 'w', encoding='utf-8') as f:
                f.write(content)
            QMessageBox.information(self, "æˆåŠŸ", "é…ç½®å·²ä¿å­˜ã€‚è¯·é‡å¯ç›¸å…³æœåŠ¡ä»¥ç”Ÿæ•ˆã€‚")
        except Exception as e:
            QMessageBox.critical(self, "ä¿å­˜å¤±è´¥", str(e))